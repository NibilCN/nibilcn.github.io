<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="掌握设备树是Linux驱动开发人员必备的技能，因为在新版本的Linux内核中，ARM相关的驱动全部采用的设备树，最新出的CPU及其驱动开发也基本基于设备树。比如ST出的STM32MP157、NXP的I.MX8系列等。我们所使用的Linux版本为4.1.15，其支持设备树。所以正点原子I.MX6U-ALPHA开发板的所有Linux驱动都是基于设备树的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux设备树">
<meta property="og:url" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/index.html">
<meta property="og:site_name" content="Laugh Tale">
<meta property="og:description" content="掌握设备树是Linux驱动开发人员必备的技能，因为在新版本的Linux内核中，ARM相关的驱动全部采用的设备树，最新出的CPU及其驱动开发也基本基于设备树。比如ST出的STM32MP157、NXP的I.MX8系列等。我们所使用的Linux版本为4.1.15，其支持设备树。所以正点原子I.MX6U-ALPHA开发板的所有Linux驱动都是基于设备树的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/1.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/2.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/3.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/4.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/5.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/6.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/7.jpeg">
<meta property="og:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/8.jpeg">
<meta property="article:published_time" content="2023-06-08T07:34:31.000Z">
<meta property="article:modified_time" content="2023-06-08T07:34:31.000Z">
<meta property="article:author" content="Nibil">
<meta property="article:tag" content="Linux Kernel">
<meta property="article:tag" content="Linux 设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/1.jpeg">


<link rel="canonical" href="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/","path":"2023/06/08/Linux设备树/","title":"Linux设备树"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux设备树 | Laugh Tale</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
  <!--pjax：防止跳转页面音乐暂停-->
  <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Laugh Tale</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A Nibil's Sharing Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">设备树的概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%AE%BE%E5%A4%87%E6%A0%91%EF%BC%9F"><span class="nav-number">1.1.</span> <span class="nav-text">什么是设备树？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DTS%E3%80%81DTB%E5%92%8CDTC"><span class="nav-number">1.2.</span> <span class="nav-text">DTS、DTB和DTC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DTS%E8%AF%AD%E6%B3%95"><span class="nav-number">1.3.</span> <span class="nav-text">DTS语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dtsi%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.1.</span> <span class="nav-text">dtsi头文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9"><span class="nav-number">1.3.2.</span> <span class="nav-text">设备节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%87%86%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.</span> <span class="nav-text">标准属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#compatible%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">compatible属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#model%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">model属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#status%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">status属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#address-cells%E3%80%81-size-cells"><span class="nav-number">1.3.3.4.</span> <span class="nav-text">#address-cells、#size-cells</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reg%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.5.</span> <span class="nav-text">reg属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ranges%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.6.</span> <span class="nav-text">ranges属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#name%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.7.</span> <span class="nav-text">name属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#device-type%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.3.8.</span> <span class="nav-text">device_type属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E8%8A%82%E7%82%B9compatible%E5%B1%9E%E6%80%A7"><span class="nav-number">1.3.4.</span> <span class="nav-text">根节点compatible属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E8%8A%82%E7%82%B9%E8%BF%BD%E5%8A%A0%E6%88%96%E4%BF%AE%E6%94%B9%E5%86%85%E5%AE%B9"><span class="nav-number">1.3.5.</span> <span class="nav-text">向节点追加或修改内容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%B0%8F%E5%9E%8B%E6%A8%A1%E6%9D%BF%E8%AE%BE%E5%A4%87%E6%A0%91"><span class="nav-number">1.4.</span> <span class="nav-text">创建小型模板设备树</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0cpus%E8%8A%82%E7%82%B9"><span class="nav-number">1.4.1.</span> <span class="nav-text">添加cpus节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0soc%E8%8A%82%E7%82%B9"><span class="nav-number">1.4.2.</span> <span class="nav-text">添加soc节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0ocram%E8%8A%82%E7%82%B9"><span class="nav-number">1.4.3.</span> <span class="nav-text">添加ocram节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0aips1%E3%80%81aips2%E5%92%8C%E5%92%8Caips3%E8%BF%99%E4%B8%89%E4%B8%AA%E5%AD%90%E8%8A%82%E7%82%B9"><span class="nav-number">1.4.4.</span> <span class="nav-text">添加aips1、aips2和和aips3这三个子节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0ecspi1%E3%80%81usbotg1%E5%92%8C%E5%92%8Crngb%E8%BF%99%E4%B8%89%E4%B8%AA%E5%A4%96%E8%AE%BE%E6%8E%A7%E5%88%B6%E5%99%A8%E8%8A%82%E7%82%B9"><span class="nav-number">1.4.5.</span> <span class="nav-text">添加ecspi1、usbotg1和和rngb这三个外设控制器节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8OF%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="nav-number">2.</span> <span class="nav-text">常用OF操作函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E5%9C%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="nav-number">2.1.</span> <span class="nav-text">设备树在系统中的体现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E8%8A%82%E7%82%B9%E2%80%9C-x2F-%E2%80%9D%E5%90%84%E4%B8%AA%E5%B1%9E%E6%80%A7"><span class="nav-number">2.1.1.</span> <span class="nav-text">根节点“&#x2F;”各个属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B9%E8%8A%82%E7%82%B9%E2%80%9C-x2F-%E2%80%9D%E5%90%84%E5%AD%90%E8%8A%82%E7%82%B9"><span class="nav-number">2.1.2.</span> <span class="nav-text">根节点“&#x2F;”各子节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E8%8A%82%E7%82%B9"><span class="nav-number">2.2.</span> <span class="nav-text">特殊节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aliases%E5%AD%90%E8%8A%82%E7%82%B9"><span class="nav-number">2.2.1.</span> <span class="nav-text">aliases子节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chosen%E5%AD%90%E8%8A%82%E7%82%B9"><span class="nav-number">2.2.2.</span> <span class="nav-text">chosen子节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E5%A4%87%E6%A0%91%E5%B8%B8%E7%94%A8OF%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.</span> <span class="nav-text">设备树常用OF操作函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E8%8A%82%E7%82%B9%E7%9A%84OF%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.</span> <span class="nav-text">查找节点的OF函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-node-by-name%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">of_find_node_by_name函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-node-by-type%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">of_find_node_by_type函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-compatible-node%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">of_find_compatible_node函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-matching-node-and-match%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.4.</span> <span class="nav-text">of_find_matching_node_and_match函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-node-by-path%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.5.</span> <span class="nav-text">of_find_node_by_path函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E7%88%B6-x2F-%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84OF%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.2.</span> <span class="nav-text">查找父&#x2F;子节点的OF函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#of-get-parent%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">of_get_parent函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E5%8F%96%E5%B1%9E%E6%80%A7%E5%80%BC%E7%9A%84OF%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.</span> <span class="nav-text">提取属性值的OF函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#of-find-property%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">of_find_property函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-property-count-elems-of-size%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">of_property_count_elems_of_size函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-property-read-u32-index%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.3.</span> <span class="nav-text">of_property_read_u32_index函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-property-read-u8-array%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u16-array%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u32-array%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u64-array%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.4.</span> <span class="nav-text">of_property_read_u8_array函数、of_property_read_u16_array函数、of_property_read_u32_array函数、of_property_read_u64_array函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-property-read-u8%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u16%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u32%E5%87%BD%E6%95%B0%E3%80%81of-property-read-u64%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.5.</span> <span class="nav-text">of_property_read_u8函数、of_property_read_u16函数、of_property_read_u32函数、of_property_read_u64函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-property-read-string%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.6.</span> <span class="nav-text">of_property_read_string函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-n-addr-cells%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.7.</span> <span class="nav-text">of_n_addr_cells函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-n-size-cells%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.3.8.</span> <span class="nav-text">of_n_size_cells函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E7%9A%84OF%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.</span> <span class="nav-text">其他常用的OF函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#of-device-is-compatible%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">of_device_is_compatible函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-get-address%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">of_get_address函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-translate-address%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.3.</span> <span class="nav-text">of_translate_address函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-address-to-resource%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.4.</span> <span class="nav-text">of_address_to_resource函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#of-iomap%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.4.5.</span> <span class="nav-text">of_iomap函数</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Nibil</p>
  <div class="site-description" itemprop="description">A Nibil's Sharing Blog</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">58</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">74</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/NibilCN" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;NibilCN" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
    <div class="sidebar-inner">
      <!-- require APlayer -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
      <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
      <!-- require MetingJS -->
      <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
      <!--网易云-->   
      <meting-js
        server="netease"
        id="7593069088"
        type="playlist" 
        mini="false"
        fixed="false"
        list-folded="true"
        autoplay="true"
        volume="0.4"
        theme="#FADFA3"
        order="random"
        loop="all"
        preload="auto"
        mutex="true">
      </meting-js>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/NibilCN" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Nibil">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laugh Tale">
      <meta itemprop="description" content="A Nibil's Sharing Blog">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux设备树 | Laugh Tale">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux设备树
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-08 15:34:31" itemprop="dateCreated datePublished" datetime="2023-06-08T15:34:31+08:00">2023-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/%E5%8D%9A%E5%AE%A2/" itemprop="url" rel="index"><span itemprop="name">博客</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0/%E5%8D%9A%E5%AE%A2/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/" itemprop="url" rel="index"><span itemprop="name">Linux设备树</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>32k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>29 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>掌握设备树是Linux驱动开发人员必备的技能，因为在新版本的Linux内核中，ARM相关的驱动全部采用的设备树，最新出的CPU及其驱动开发也基本基于设备树。比如ST出的STM32MP157、NXP的I.MX8系列等。我们所使用的Linux版本为4.1.15，其支持设备树。所以正点原子I.MX6U-ALPHA开发板的所有Linux驱动都是基于设备树的。</p>
<span id="more"></span>
<h1 id="设备树的概念"><a href="#设备树的概念" class="headerlink" title="设备树的概念"></a>设备树的概念</h1><h2 id="什么是设备树？"><a href="#什么是设备树？" class="headerlink" title="什么是设备树？"></a>什么是设备树？</h2><p>设备树（Device Tree），将这个词分开就是设备和树，<code>描述设备树的文件叫做DTS（device tree source）</code>，这个dts文件采用树形结构描述板级设备，也就是开发板上的设备信息，比如CPU数量、内存基地址、IIC接口上接了哪些设备、SPI接口上接了哪些设备等等。如下图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/1.jpeg" alt="img not found"><br>在图中，<code>树的主干就是系统总线，IIC控制器、GPIO控制器、SPI控制器等都是接到系统主线上的分支。</code>IIC控制器有分IIC1和IIC2两种，其中IIC1上接了FT5236和AT24C02两个IIC设备，IIC2只接了MPU6050这个设备。<br>DTS文件的主要功能就是按照图所示的结构来描述板子上的设备信息，DTS文件描述设备信息是有相应的语法规则要求的。<br>在Linux内核源码中大量的arch&#x2F;arm&#x2F;mach-xxx和arch&#x2F;arm&#x2F;plat-xxx文件夹，这些文件夹里面的文件就是对应平台下的板级信息。比如在arch&#x2F;arm&#x2F;mach-smdk2440.c中有如下内容(有缩减)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">90</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3c2410fb_display</span> <span class="title">smdk2440_lcd_cfg</span> __<span class="title">initdata</span> =</span> &#123;</span><br><span class="line"><span class="number">91</span></span><br><span class="line"><span class="number">92</span> 		.lcdcon5 = S3C2410_LCDCON5_FRM565 |</span><br><span class="line"><span class="number">93</span> 					S3C2410_LCDCON5_INVVLINE |</span><br><span class="line"><span class="number">94</span> 					S3C2410_LCDCON5_INVVFRAME |</span><br><span class="line"><span class="number">95</span> 					S3C2410_LCDCON5_PWREN |</span><br><span class="line"><span class="number">96</span> 					S3C2410_LCDCON5_HWSWP,</span><br><span class="line">......</span><br><span class="line"><span class="number">113</span> &#125;;</span><br><span class="line"><span class="number">114</span></span><br><span class="line"><span class="number">115</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">s3c2410fb_mach_info</span> <span class="title">smdk2440_fb_info</span> __<span class="title">initdata</span> =</span> &#123;</span><br><span class="line"><span class="number">116</span> 	.displays = &amp;smdk2440_lcd_cfg,</span><br><span class="line"><span class="number">117</span> 	.num_displays = <span class="number">1</span>,</span><br><span class="line"><span class="number">118</span> 	.default_display = <span class="number">0</span>,</span><br><span class="line">......</span><br><span class="line"><span class="number">133</span> &#125;;</span><br><span class="line"><span class="number">134</span></span><br><span class="line"><span class="number">135</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span> *<span class="title">smdk2440_devices</span>[] __<span class="title">initdata</span> =</span> &#123;</span><br><span class="line"><span class="number">136</span> 	&amp;s3c_device_ohci,</span><br><span class="line"><span class="number">137</span> 	&amp;s3c_device_lcd,</span><br><span class="line"><span class="number">138</span> 	&amp;s3c_device_wdt,</span><br><span class="line"><span class="number">139</span> 	&amp;s3c_device_i2c0,</span><br><span class="line"><span class="number">140</span> 	&amp;s3c_device_iis,</span><br><span class="line"><span class="number">141</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>上述代码中的结构体变量smdk2440_fb_info就是描述SMDK2440这个开发板上的LCD信息的，结构体指针数组smdk2440_devices描述的SMDK2440这个开发板上的所有平台相关信息。<br>一个SOC可以作出很多不同的板子，这些不同的板子肯定是有共同的信息，将这些共同的信息提取出来作为一个通用的文件，其他的.dts文件直接引用这个通用文件即可，<code>这个通用文件就是.dtsi文件，类似于C语言中的头文件。一般.dts描述板级信息(也就是开发板上有哪些IIC设备、SPI设备等)，.dtsi描述SOC级信息(也就是SOC有几个CPU、主频是多少、各个外设控制器信息等)。</code>这个就是设备树的由来，简而言之就是，Linux内核中ARM架构下有太多的冗余的垃圾板级信息文件，导致linus震怒，然后ARM社区引入了设备树。</p>
<h2 id="DTS、DTB和DTC"><a href="#DTS、DTB和DTC" class="headerlink" title="DTS、DTB和DTC"></a>DTS、DTB和DTC</h2><p>DTS是设备树源码文件，DTB是将DTS编译以后得到的二进制文件。将.c文件编译为.o需要用到gcc编译器，那么将.dts编译为.dtb需要什么工具呢？需要用到DTC具！DTC工具源码在Linux内核的scripts&#x2F;dtc目录下。</p>
<h2 id="DTS语法"><a href="#DTS语法" class="headerlink" title="DTS语法"></a>DTS语法</h2><p>虽然我们基本上不会重新写一个dts文件，大多时候是直接在SOC厂商提供的dts文件上进行修改。但是DTS文件语法我们还是需要详细的学习一遍，因为我们肯定需要修改dts文件。DTS的语法非常人性化，是一种ASCII文本文件，不管是阅读还是修改都很方便。</p>
<h3 id="dtsi头文件"><a href="#dtsi头文件" class="headerlink" title="dtsi头文件"></a>dtsi头文件</h3><p>和C语言一样，设备树也支持头文件，设备树的头文件扩展名为.dtsi。在imx6ull-alientek-emmc.dts中有如下所示内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/input/input.h&gt;</span></span></span><br><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull.dtsi&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>第12行，使用“#include”来引用“input.h”这个头文件。<br>第13行，使用“#include”来引用“imx6ull.dtsi”这个dtsi头文件。<br><code>在.dts设备树文件中，可以通过“#include”来引用.h、.dtsi和.dts文件。只是，我们在编写设备树头文件的时候最好选择.dtsi后缀。</code><br>一般dtsi文件用于描述SOC的内部外设信息，比如CPU架构、主频、外设寄存器地址范围，比如UART、IIC等等。比如imx6ull.dtsi就是描述I.MX6ULL这颗SOC内部外设情况信息的，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/clock/imx6ul-clock.h&gt;</span></span></span><br><span class="line"><span class="number">11</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/gpio/gpio.h&gt;</span></span></span><br><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dt-bindings/interrupt-controller/arm-gic.h&gt;</span></span></span><br><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull-pinfunc.h&quot;</span></span></span><br><span class="line"><span class="number">14</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;imx6ull-pinfunc-snvs.h&quot;</span></span></span><br><span class="line"><span class="number">15</span> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;skeleton.dtsi&quot;</span></span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> / &#123;</span><br><span class="line"><span class="number">18</span> 		aliases &#123;</span><br><span class="line"><span class="number">19</span> 			can0 = &amp;flexcan1;</span><br><span class="line">......</span><br><span class="line"><span class="number">48</span> 		&#125;;</span><br><span class="line"><span class="number">49</span></span><br><span class="line"><span class="number">50</span> 		cpus &#123;</span><br><span class="line"><span class="number">51</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">52</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">53</span></span><br><span class="line"><span class="number">54</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">55</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">56</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">89</span> 			&#125;;</span><br><span class="line"><span class="number">90</span> 		&#125;;</span><br><span class="line"><span class="number">91</span></span><br><span class="line"><span class="number">92</span> 		intc: interrupt-controller@<span class="number">00</span>a01000 &#123;</span><br><span class="line"><span class="number">93</span> 			compatible = <span class="string">&quot;arm,cortex-a7-gic&quot;</span>;</span><br><span class="line"><span class="number">94</span> 			<span class="meta">#interrupt-cells = <span class="string">&lt;3&gt;</span>;</span></span><br><span class="line"><span class="number">95</span> 			interrupt-controller;</span><br><span class="line"><span class="number">96</span> 			reg = &lt;<span class="number">0x00a01000</span> <span class="number">0x1000</span>&gt;,</span><br><span class="line"><span class="number">97</span> 				&lt;<span class="number">0x00a02000</span> <span class="number">0x100</span>&gt;;</span><br><span class="line"><span class="number">98</span> 		&#125;;</span><br><span class="line"><span class="number">99</span></span><br><span class="line"><span class="number">100</span> 	clocks &#123;</span><br><span class="line"><span class="number">101</span> 		<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">102</span> 		<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">103</span></span><br><span class="line"><span class="number">104</span> 	ckil: clock@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">105</span> 		compatible = <span class="string">&quot;fixed-clock&quot;</span>;</span><br><span class="line"><span class="number">106</span> 		reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">107</span> 		<span class="meta">#clock-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">108</span> 		clock-frequency = &lt;<span class="number">32768</span>&gt;;</span><br><span class="line"><span class="number">109</span> 		clock-output-names = <span class="string">&quot;ckil&quot;</span>;</span><br><span class="line"><span class="number">110</span> 	&#125;;</span><br><span class="line">......</span><br><span class="line"><span class="number">135</span> &#125;;</span><br><span class="line"><span class="number">136</span></span><br><span class="line"><span class="number">137</span> soc &#123;</span><br><span class="line"><span class="number">138</span> 	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">139</span> 	<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">140</span> 	compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">141</span> 	interrupt-parent = &lt;&amp;gpc&gt;;</span><br><span class="line"><span class="number">142</span> 	ranges;</span><br><span class="line"><span class="number">143</span></span><br><span class="line"><span class="number">144</span> 	busfreq &#123;</span><br><span class="line"><span class="number">145</span> 		compatible = <span class="string">&quot;fsl,imx_busfreq&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">162</span> 	&#125;;</span><br><span class="line"><span class="number">197</span></span><br><span class="line"><span class="number">198</span> 	gpmi: gpmi-nand@<span class="number">01806000</span>&#123;</span><br><span class="line"><span class="number">199</span> 		compatible = <span class="string">&quot;fsl,imx6ull-gpmi-nand&quot;</span>, <span class="string">&quot;fsl, imx6ul-gpmi-nand&quot;</span>;</span><br><span class="line"><span class="number">200</span> 		<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">201</span> 		<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">202</span> 		reg = &lt;<span class="number">0x01806000</span> <span class="number">0x2000</span>&gt;, &lt;<span class="number">0x01808000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">......</span><br><span class="line"><span class="number">216</span> 		&#125;;</span><br><span class="line">......</span><br><span class="line"><span class="number">1177</span> 	&#125;;</span><br><span class="line"><span class="number">1178</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>以上代码中第54-89行就是cpu0这个设备节点信息，这个节点信息描述了I.MX6ULL这颗SOC所使用的CPU信息，比如架构是cortex-A7，频率支持996MHz、792MHz、528MHz、396MHz和198MHz等等。在imx6ull.dtsi文件中不仅仅描述了cpu0这一个节点信息，I.MX6ULL这颗SOC所有的外设都描述的清清楚楚，比如ecspi1<del>4、uart1</del>8、usbphy1<del>2、i2c1</del>4等等。</p>
<h3 id="设备节点"><a href="#设备节点" class="headerlink" title="设备节点"></a>设备节点</h3><p>设备树是采用树形结构来描述板子上的设备信息的文件，每个设备都是一个节点，叫做设备节点，每个节点都通过一些属性信息来描述节点信息，属性就是键值对。以下是从imx6ull.dtsi文件中缩减出来的设备树文件内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		aliases &#123;</span><br><span class="line"><span class="number">3</span> 			can0 = &amp;flexcan1;</span><br><span class="line"><span class="number">4</span> 		&#125;;</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span> 		cpus &#123;</span><br><span class="line"><span class="number">7</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">8</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">11</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">12</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">13</span> 				reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">14</span> 			&#125;;</span><br><span class="line"><span class="number">15</span> 		&#125;;</span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> 		intc: interrupt-controller@<span class="number">00</span>a01000 &#123;</span><br><span class="line"><span class="number">18</span> 			compatible = <span class="string">&quot;arm,cortex-a7-gic&quot;</span>;</span><br><span class="line"><span class="number">19</span> 			<span class="meta">#interrupt-cells = <span class="string">&lt;3&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> 			interrupt-controller;</span><br><span class="line"><span class="number">21</span> 			reg = &lt;<span class="number">0x00a01000</span> <span class="number">0x1000</span>&gt;,</span><br><span class="line"><span class="number">22</span> 					&lt;<span class="number">0x00a02000</span> <span class="number">0x100</span>&gt;;</span><br><span class="line"><span class="number">23</span> 		&#125;;</span><br><span class="line"><span class="number">24</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第一行，“&#x2F;”是根节点，<code>每个设备树文件只有一个根节点</code>。imx6ull.dtsi和imx6ull-alientek-emmc.dts这两个文件都有一个“&#x2F;”根节点，这两个“&#x2F;”根节点的内容会合并成一个根节点。<br>第2、6和17行，aliases、cpus和intc是三个子节点，在设备树中节点命名格式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-name@unit-address</span><br></pre></td></tr></table></figure>
<p>其中“node-name”是节点名字，为ASCII字符串，节点名字应该能够清晰的描述出节点的功能，比如“uart1”就表示这个节点是UART1外设。“unit-address”一般表示设备的地址或寄存器首地址，如果某个节点没有地址或者寄存器的话“unit-address”可以不要，比如“cpu@0”、“interrupt-controller@00a01000”。<br>但是我们在以上代码中我们看到的节点命名却如下所示:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpu0:cpu@<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>上述命令并不是“node-name@unit-address”这样的格式，而是用“：”隔开成了两部分，“：”前面的是节点标签(label)，“：”后面的才是节点名字，格式如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label: node-name@unit-address</span><br></pre></td></tr></table></figure>
<p><code>引入label的目的就是为了方便访问节点，可以直接通过&amp;label来访问这个节点，</code>比如通过&amp;cpu0就可以访问“cpu@0”这个节点，而不需要输入完整的节点名字。再比如节点“intc:interrupt-controller@00a01000”，节点label是intc，而节点名字就很长了，为“interrupt-controller@00a01000”。很明显通过&amp;intc来访问“interrupt-controller@00a01000”这个节点要方便很多！<br>第10行，cpu0也是一个节点，只是cpu0是cpus的子节点。每个节点都有不同属性，不同的属性又有不同的内容，属性都是键值对，值可以为空或任意的字节流。设备树源码中常用的几种数据形式如下所示：</p>
<ol>
<li>字符串<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br></pre></td></tr></table></figure></li>
<li>32位无符号整数<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;<span class="number">0</span>&gt;;</span><br></pre></td></tr></table></figure>
上述代码设置reg属性的值为0，reg的值也可以设置为一组值，比如：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;<span class="number">0</span> <span class="number">0x123456</span> <span class="number">100</span>&gt;;</span><br></pre></td></tr></table></figure></li>
<li>字符串列表<br>属性值也可以为字符串列表，字符串和字符串之间采用“,”隔开，如下所示：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = <span class="string">&quot;fsl,imx6ull-gpmi-nand&quot;</span>, <span class="string">&quot;fsl, imx6ul-gpmi-nand&quot;</span>;</span><br></pre></td></tr></table></figure>
上述代码设置属性compatible的值为“fsl,imx6ull-gpmi-nand”和“fsl,imx6ul-gpmi-nand”。</li>
</ol>
<h3 id="标准属性"><a href="#标准属性" class="headerlink" title="标准属性"></a>标准属性</h3><p>节点是由一堆的属性组成，节点都是具体的设备，不同的设备需要的属性不同，用户可以自定义属性。除了用户自定义属性，有很多属性是标准属性，Linux下的很多外设驱动都会使用这些标准属性，本节我们就来学习一下几个常用的标准属性。</p>
<h4 id="compatible属性"><a href="#compatible属性" class="headerlink" title="compatible属性"></a>compatible属性</h4><p>compatible属性也叫做“兼容性”属性，这是非常重要的一个属性！compatible属性的值是一个字符串列表，<code>compatible属性用于将设备和驱动绑定起来</code>。字符串列表用于选择设备所要使用的驱动程序，compatible属性的值格式如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;manufacturer,model&quot;</span></span><br></pre></td></tr></table></figure>
<p>其中manufacturer表示厂商，model一般是模块对应的驱动名字。比如imx6ull-alientek-emmc.dts中sound节点是I.MX6U-ALPHA开发板的音频设备节点，I.MX6U-ALPHA开发板上的音频芯片采用的欧胜(WOLFSON)出品的WM8960，sound节点的compatible属性值如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compatible = <span class="string">&quot;fsl,imx6ul-evk-wm8960&quot;</span>,<span class="string">&quot;fsl,imx-audio-wm8960&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>属性值有两个，分别为“fsl,imx6ul-evk-wm8960”和“fsl,imx-audio-wm8960”，其中“fsl”表示厂商是飞思卡尔，“imx6ul-evk-wm8960”和“imx-audio-wm8960”表示驱动模块名字。sound这个设备首先使用第一个兼容值在Linux内核里面查找，看看能不能找到与之匹配的驱动文件，如果没有找到的话就使用第二个兼容值查。<br>一般驱动程序文件都会有一个OF匹配表，此OF匹配表保存着一些compatible值，如果设备节点的compatible属性值和OF匹配表中的任何一个值相等，那么就表示设备可以使用这个驱动。比如在文件imx-wm8960.c中有如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">632</span> <span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">imx_wm8960_dt_ids</span>[] =</span> &#123;</span><br><span class="line"><span class="number">633</span> 	&#123; .compatible = <span class="string">&quot;fsl,imx-audio-wm8960&quot;</span>, &#125;,</span><br><span class="line"><span class="number">634</span> 	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line"><span class="number">635</span> &#125;;</span><br><span class="line"><span class="number">636</span> MODULE_DEVICE_TABLE(of, imx_wm8960_dt_ids);</span><br><span class="line"><span class="number">637</span></span><br><span class="line"><span class="number">638</span> <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">imx_wm8960_driver</span> =</span> &#123;</span><br><span class="line"><span class="number">639</span> 	.driver = &#123;</span><br><span class="line"><span class="number">640</span> 		.name = <span class="string">&quot;imx-wm8960&quot;</span>,</span><br><span class="line"><span class="number">641</span> 		.pm = &amp;snd_soc_pm_ops,</span><br><span class="line"><span class="number">642</span> 		.of_match_table = imx_wm8960_dt_ids,</span><br><span class="line"><span class="number">643</span> 	&#125;,</span><br><span class="line"><span class="number">644</span> 	.probe = imx_wm8960_probe,</span><br><span class="line"><span class="number">645</span> 	.remove = imx_wm8960_remove,</span><br><span class="line"><span class="number">646</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>第632~635行的数组imx_wm8960_dt_ids就是imx-wm8960.c这个驱动文件的匹配表，此匹配表只有一个匹配值“fsl,imx-audio-wm8960”。如果在设备树中有哪个节点的compatible属性值与此相等，那么这个节点就会使用此驱动文件。第642行，wm8960采用了platform_driver驱动模式，关于platform_driver驱动后面会讲解。此行设置.of_match_table为imx_wm8960_dt_ids，也就是设置这个platform_driver所使用的OF匹配表。</p>
<h4 id="model属性"><a href="#model属性" class="headerlink" title="model属性"></a>model属性</h4><p>model属性值也是一个字符串，一般model属性描述设备模块信息，比如名字什么的，比如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="string">&quot;wm8960-audio&quot;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="status属性"><a href="#status属性" class="headerlink" title="status属性"></a>status属性</h4><p>status属性看名字就知道是和设备状态有关的，status属性值也是字符串，字符串是设备的状态信息，可选的状态如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/2.jpeg" alt="img not found"></p>
<h4 id="address-cells、-size-cells"><a href="#address-cells、-size-cells" class="headerlink" title="#address-cells、#size-cells"></a>#address-cells、#size-cells</h4><p>这两个属性的值都是无符号32位整形，<code>#address-cells和#size-cells这两个属性可以用在任何拥有子节点的设备中，用于描述子节点的地址信息。#address-cells属性值决定了子节点reg属性中地址信息所占用的字长(32位)，#size-cells属性值决定了子节点reg属性中长度信息所占的字长(32位)。#address-cells和#size-cells表明了子节点应该如何编写reg属性值</code>，一般reg属性都是和地址有关的内容，和地址相关的信息有两种：起始地址和地址长度，reg属性的格式为:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg = &lt;address1 length1 address2 length2 address3 length3……&gt;</span><br></pre></td></tr></table></figure>
<p>每个“address length”组合表示一个地址范围，其中address是起始地址，length是地址长度，#address-cells表明address这个数据所占用的字长，size-cells表明length这个数据所占用的字长，比如:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> spi4 &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;spi-gpio&quot;</span>;</span><br><span class="line"><span class="number">3</span> 		<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">4</span> 		<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span> 		gpio_spi: gpio_spi@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">7</span> 			compatible = <span class="string">&quot;fairchild,74hc595&quot;</span>;</span><br><span class="line"><span class="number">8</span> 			reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">9</span> 		&#125;;</span><br><span class="line"><span class="number">10</span> &#125;;</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> aips3: aips-bus@<span class="number">02200000</span> &#123;</span><br><span class="line"><span class="number">13</span> 		compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">14</span> 		<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">15</span> 		<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="number">17</span> 		dcp: dcp@<span class="number">02280000</span> &#123;</span><br><span class="line"><span class="number">18</span> 			compatible = <span class="string">&quot;fsl,imx6sl-dcp&quot;</span>;</span><br><span class="line"><span class="number">19</span> 			reg = &lt;<span class="number">0x02280000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">20</span> 		&#125;;</span><br><span class="line"><span class="number">21</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>第3，4行，节点spi4的#address-cells&#x3D;&lt;1&gt;，#size-cells&#x3D;&lt;0&gt;，说明spi4的子节点reg属性中起始地址所占用的字长为1，地址长度所占用的字长为0。第8行，子节点gpio_spi:gpio_spi@0的reg属性值为&lt;0&gt;，因为父节点设置了#address-cells&#x3D;&lt;1&gt;，#size-cells&#x3D;&lt;0&gt;，因此addres&#x3D;0，没有length的值，相当于设置了起始地址，而没有设置地址长度。<br>第14，15行，设置aips3:aips-bus@02200000节点#address-cells&#x3D;&lt;1&gt;，#size-cells&#x3D;&lt;1&gt;，说明aips3:aips-bus@02200000节点起始地址长度所占用的字长为1，地址长度所占用的字长也为1。第19行，子节点dcp:dcp@02280000的reg属性值为&lt;0x022800000x4000&gt;，因为父节点设置了#address-cells&#x3D;&lt;1&gt;，#size-cells&#x3D;&lt;1&gt;，address&#x3D;0x02280000，length&#x3D;0x4000，相当于设置了起始地址为0x02280000，地址长度为0x4000。</p>
<h4 id="reg属性"><a href="#reg属性" class="headerlink" title="reg属性"></a>reg属性</h4><p>reg属性前面已经提到过了，reg属性的值一般是(address，length)对。<code>reg属性一般用于描述设备地址空间资源信息，一般都是某个外设的寄存器地址范围信息</code>，比如在imx6ull.dtsi中有如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">323</span> uart1: serial@<span class="number">02020000</span> &#123;</span><br><span class="line"><span class="number">324</span> 	compatible = <span class="string">&quot;fsl,imx6ul-uart&quot;</span>,</span><br><span class="line"><span class="number">325</span> 				<span class="string">&quot;fsl,imx6q-uart&quot;</span>, <span class="string">&quot;fsl,imx21-uart&quot;</span>;</span><br><span class="line"><span class="number">326</span> 	reg = &lt;<span class="number">0x02020000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">327</span> 	interrupts = &lt;GIC_SPI <span class="number">26</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"><span class="number">328</span> 	clocks = &lt;&amp;clks IMX6UL_CLK_UART1_IPG&gt;,</span><br><span class="line"><span class="number">329</span> 	&lt;&amp;clks IMX6UL_CLK_UART1_SERIAL&gt;;</span><br><span class="line"><span class="number">330</span> 	clock-names = <span class="string">&quot;ipg&quot;</span>, <span class="string">&quot;per&quot;</span>;</span><br><span class="line"><span class="number">331</span> 	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">332</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>上述代码是节点uart1，uart1节点描述了I.MX6ULL的UART1相关信息，重点是第326行的reg属性。其中uart1的父节点aips1:aips-bus@02000000设置了address-cells&#x3D;&lt;1&gt;、#size-cells&#x3D;&lt;1&gt;，因此reg属性中address&#x3D;0x02020000，length&#x3D;0x4000。查阅《I.MX6ULL参考手册》可知，I.MX6ULL的UART1寄存器首地址为0x02020000，但是UART1的地址长度(范围)并没有0x4000这么多，这里我们重点是获取UART1寄存器首地址。</p>
<h4 id="ranges属性"><a href="#ranges属性" class="headerlink" title="ranges属性"></a>ranges属性</h4><p>ranges属性值可以为空或者按照(child-bus-address,parent-bus-address,length)格式编写的数字矩阵，ranges是一个地址映射&#x2F;转换表，ranges属性每个项目由子地址、父地址和地址空间长度这三部分组成：<br><code>child-bus-address</code>:子总线地址空间的物理地址，由父节点的#address-cells确定此物理地址所占用的字长。<br><code>parent-bus-address</code>:父总线地址空间的物理地址，同样由父节点的#address-cells确定此物理地址所占用的字长。<br><code>length</code>:子地址空间的长度，由父节点的#size-cells确定此地址长度所占用的字长。如果ranges属性值为空值，说明子地址空间和父地址空间完全相同，不需要进行地址转换，对于我们所使用的I.MX6ULL来说，子地址空间和父地址空间完全相同，因此会在imx6ull.dtsi中找到大量的值为空的ranges属性，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">137</span> soc &#123;</span><br><span class="line"><span class="number">138</span> 	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">139</span> 	<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">140</span> 	compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">141</span> 	interrupt-parent = &lt;&amp;gpc&gt;;</span><br><span class="line"><span class="number">142</span> 	ranges;</span><br><span class="line">......</span><br><span class="line"><span class="number">1177</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第142行定义了ranges属性，但是ranges属性值为空。<br>ranges属性不为空的示例代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> soc &#123;</span><br><span class="line"><span class="number">2</span> 	compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">3</span> 	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">4</span> 	<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">5</span> 	ranges = &lt;<span class="number">0x0</span> <span class="number">0xe0000000</span> <span class="number">0x00100000</span>&gt;;</span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span> 	serial &#123;</span><br><span class="line"><span class="number">8</span> 		device_type = <span class="string">&quot;serial&quot;</span>;</span><br><span class="line"><span class="number">9</span> 		compatible = <span class="string">&quot;ns16550&quot;</span>;</span><br><span class="line"><span class="number">10</span> 		reg = &lt;<span class="number">0x4600</span> <span class="number">0x100</span>&gt;;</span><br><span class="line"><span class="number">11</span> 		clock-frequency = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">12</span> 		interrupts = &lt;<span class="number">0xA</span> <span class="number">0x8</span>&gt;;</span><br><span class="line"><span class="number">13</span> 		interrupt-parent = &lt;&amp;ipic&gt;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>第5行，节点soc定义的ranges属性，值为&lt;0x0 0xe0000000 0x00100000&gt;，此属性值指定了一个1024KB(0x00100000)的地址范围，子地址空间的物理起始地址为0x0，父地址空间的物理起始地址为0xe0000000。<br>第10行，serial是串口设备节点，reg属性定义了serial设备寄存器的起始地址为0x4600，寄存器长度为0x100。经过地址转换，serial设备可以从0xe0004600开始进行读写操作，0xe0004600&#x3D;0x4600+0xe0000000。</p>
<h4 id="name属性"><a href="#name属性" class="headerlink" title="name属性"></a>name属性</h4><p>name属性值为字符串，name属性用于记录节点名字，name属性已经被弃用，不推荐使用name属性，一些老的设备树文件可能会使用此属性。</p>
<h4 id="device-type属性"><a href="#device-type属性" class="headerlink" title="device_type属性"></a>device_type属性</h4><p>device_type属性值为字符串，IEEE1275会用到此属性，用于描述设备的FCode，但是设备树没有FCode，所以此属性也被抛弃了。此属性只能用于cpu节点或者memory节点。imx6ull.dtsi的cpu0节点用到了此属性，内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">54</span> cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">55</span> 		compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">56</span> 		device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">57</span> 		reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">......</span><br><span class="line"><span class="number">89</span> &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="根节点compatible属性"><a href="#根节点compatible属性" class="headerlink" title="根节点compatible属性"></a>根节点compatible属性</h3><p>每个节点都有compatible属性，根节点“&#x2F;”也不例外，imx6ull-alientek-emmc.dts文件中根节点的compatible属性内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span> / &#123;</span><br><span class="line"><span class="number">15</span> 		model = <span class="string">&quot;Freescale i.MX6 ULL 14x14 EVK Board&quot;</span>;</span><br><span class="line"><span class="number">16</span> 		compatible = <span class="string">&quot;fsl,imx6ull-14x14-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line">......</span><br><span class="line"><span class="number">148</span> &#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，compatible有两个值：“fsl,imx6ull-14x14-evk”和“fsl,imx6ull”。前面我们说了，设备节点的compatible属性值是为了匹配Linux内核中的驱动程序，那么根节点中的compatible属性是为了做什么工作的？通过根节点的compatible属性可以知道我们所使用的设备，一般第一个值描述了所使用的硬件设备名字，比如这里使用的是“imx6ull-14x14-evk”这个设备，第二个值描述了设备所使用的SOC，比如这里使用的是“imx6ull”这颗SOC。<code>Linux内核会通过根节点的compoatible属性查看是否支持此设备，如果支持的话设备就会启动Linux内核。</code></p>
<h3 id="向节点追加或修改内容"><a href="#向节点追加或修改内容" class="headerlink" title="向节点追加或修改内容"></a>向节点追加或修改内容</h3><p>产品开发过程中可能面临着频繁的需求更改，比如第一版硬件上有一个IIC接口的六轴芯片MPU6050，第二版硬件又要把这个MPU6050更换为MPU9250等。一旦硬件修改了，我们就要同步的修改设备树文件，毕竟设备树是描述板子硬件信息的文件。假设现在有个六轴芯片fxls8471，fxls8471要接到I.MX6U-ALPHA开发板的I2C1接口上，那么相当于需要在i2c1这个节点上添加一个fxls8471子节点。先看一下I2C1接口对应的节点，打开文件imx6ull.dtsi文件，找到如下所示内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">937</span> i2c1: i2c@<span class="number">021</span>a0000 &#123;</span><br><span class="line"><span class="number">938</span> 	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">939</span> 	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">940</span> 	compatible = <span class="string">&quot;fsl,imx6ul-i2c&quot;</span>, <span class="string">&quot;fsl,imx21-i2c&quot;</span>;</span><br><span class="line"><span class="number">941</span> 	reg = &lt;<span class="number">0x021a0000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">942</span> 	interrupts = &lt;GIC_SPI <span class="number">36</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"><span class="number">943</span> 	clocks = &lt;&amp;clks IMX6UL_CLK_I2C1&gt;;</span><br><span class="line"><span class="number">944</span> 	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">945</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>以上代码就是I.MX6ULL的I2C1节点，现在要在i2c1节点下创建一个子节点，这个子节点就是fxls8471，最简单的方法就是在i2c1下直接添加一个名为fxls8471的子节点，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">937</span> i2c1: i2c@<span class="number">021</span>a0000 &#123;</span><br><span class="line"><span class="number">938</span> 	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">939</span> 	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">940</span> 	compatible = <span class="string">&quot;fsl,imx6ul-i2c&quot;</span>, <span class="string">&quot;fsl,imx21-i2c&quot;</span>;</span><br><span class="line"><span class="number">941</span> 	reg = &lt;<span class="number">0x021a0000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">942</span> 	interrupts = &lt;GIC_SPI <span class="number">36</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line"><span class="number">943</span> 	clocks = &lt;&amp;clks IMX6UL_CLK_I2C1&gt;;</span><br><span class="line"><span class="number">944</span> 	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">945</span></span><br><span class="line"><span class="number">946</span> 	<span class="comment">//fxls8471 子节点</span></span><br><span class="line"><span class="number">947</span> 	fxls8471@<span class="number">1</span>e &#123;</span><br><span class="line"><span class="number">948</span> 		compatible = <span class="string">&quot;fsl,fxls8471&quot;</span>;</span><br><span class="line"><span class="number">949</span> 		reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line"><span class="number">950</span> 	&#125;;</span><br><span class="line"><span class="number">951</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>第947~950行就是添加的fxls8471这个芯片对应的子节点。但是这样会有个问题！i2c1节点是定义在imx6ull.dtsi文件中的，而imx6ull.dtsi是设备树头文件，其他所有使用到I.MX6ULL这颗SOC的板子都会引用imx6ull.dtsi这个文件。直接在i2c1节点中添加fxls8471就相当于在其他的所有板子上都添加了fxls8471这个设备，但是其他的板子并没有这个设备啊！因此，按照以上代码这样写肯定是不行的。<br>这里就要引入另外一个内容，那就是如何向节点追加数据，我们现在要解决的就是如何向i2c1节点追加一个名为fxls8471的子节点，而且不能影响到其他使用到I.MX6ULL的板子。I.MX6U-ALPHA开发板使用的设备树文件为imx6ull-alientek-emmc.dts，因此我们需要在imx6ull-alientek-emmc.dts文件中完成数据追加的内容，方式如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> &amp;i2c1 &#123;</span><br><span class="line"><span class="number">2</span>     <span class="comment">/* 要追加或修改的内容 */</span></span><br><span class="line"><span class="number">3</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>第1行，&amp;i2c1表示要访问i2c1这个label所对应的节点，也就是imx6ull.dtsi中的“i2c1:i2c@021a0000”。<br>第2行，花括号内就是要向i2c1这个节点添加的内容，包括修改某些属性的值。打开imx6ull-alientek-emmc.dts，找到如下所示内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">224</span> &amp;i2c1 &#123;</span><br><span class="line"><span class="number">225</span> 	clock-frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line"><span class="number">226</span> 	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line"><span class="number">227</span> 	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c1&gt;;</span><br><span class="line"><span class="number">228</span> 	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"><span class="number">229</span></span><br><span class="line"><span class="number">230</span> 	mag3110@<span class="number">0</span>e &#123;</span><br><span class="line"><span class="number">231</span> 		compatible = <span class="string">&quot;fsl,mag3110&quot;</span>;</span><br><span class="line"><span class="number">232</span> 		reg = &lt;<span class="number">0x0e</span>&gt;;</span><br><span class="line"><span class="number">233</span> 		position = &lt;<span class="number">2</span>&gt;;</span><br><span class="line"><span class="number">234</span> 	&#125;;</span><br><span class="line"><span class="number">235</span></span><br><span class="line"><span class="number">236</span> 	fxls8471@<span class="number">1</span>e &#123;</span><br><span class="line"><span class="number">237</span> 		compatible = <span class="string">&quot;fsl,fxls8471&quot;</span>;</span><br><span class="line"><span class="number">238</span> 		reg = &lt;<span class="number">0x1e</span>&gt;;</span><br><span class="line"><span class="number">239</span> 		position = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">240</span> 		interrupt-parent = &lt;&amp;gpio5&gt;;</span><br><span class="line"><span class="number">241</span> 		interrupts = &lt;<span class="number">0</span> <span class="number">8</span>&gt;;</span><br><span class="line"><span class="number">242</span> 	&#125;;</span><br><span class="line"><span class="number">243</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>以上代码就是向i2c1节点添加&#x2F;修改数据，比如第225行的属性“clock-frequency”就表示i2c1时钟为100KHz。“clock-frequency”就是新添加的属性。<br>第228行，将status属性的值由原来的disabled改为okay。<br>第230<del>234行，i2c1子节点mag3110，因为NXP官方开发板在I2C1上接了一个磁力计芯片mag3110，正点原子的I.MX6U-ALPHA开发板并没有使用mag3110。<br>第236</del>242行，i2c1子节点fxls8471，同样是因为NXP官方开发板在I2C1上接了fxls8471这颗六轴芯片。<br>因为以上代码中的内容是imx6ull-alientek-emmc.dts这个文件内的，所以不会对使用I.MX6ULL这颗SOC的其他板子造成任何影响。这个就是向节点追加或修改内容，重点就是通过&amp;label来访问节点，然后直接在里面编写要追加或者修改的内容。</p>
<h2 id="创建小型模板设备树"><a href="#创建小型模板设备树" class="headerlink" title="创建小型模板设备树"></a>创建小型模板设备树</h2><p>上一节已经对DTS的语法做了比较详细的讲解，本节我们就根据前面讲解的语法，从头到尾编写一个小型的设备树文件。当然了，这个小型设备树没有实际的意义，做这个的目的是为了掌握设备树的语法。在实际产品开发中，我们是不需要完完全全的重写一个.dts设备树文件，一般都是使用SOC厂商提供好的.dts文件，我们只需要在上面根据自己的实际情况做相应的修改即可。在编写设备树之前要先定义一个设备，我们就以I.MX6ULL这个SOC为例，我们需要在设备树里面描述的内容如下：</p>
<ol>
<li>I.MX6ULL这个Cortex-A7架构的32位CPU。</li>
<li>I.MX6ULL内部ocram，起始地址0x00900000，大小为128KB(0x20000)。</li>
<li>I.MX6ULL内部aips1域下的ecspi1外设控制器，寄存器起始地址为0x02008000，大小为0x4000。</li>
<li>I.MX6ULL内部aips2域下的usbotg1外设控制器，寄存器起始地址为0x02184000，大小为0x4000。</li>
<li>I.MX6ULL内部aips3域下的rngb外设控制器，寄存器起始地址为0x02284000，大小为0x4000。</li>
</ol>
<p>为了简单起见，我们就在设备树里面就实现这些内容即可，首先，搭建一个仅含有根节点“&#x2F;”的基础的框架，新建一个名为myfirst.dts文件，在里面输入如下所<br>示内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span>         compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span> &#125;</span><br></pre></td></tr></table></figure>
<p>设备树框架很简单，就一个根节点“&#x2F;”，根节点里面只有一个compatible属性。我们就在这个基础框架上面将上面列出的内容一点点添加进来。</p>
<h3 id="添加cpus节点"><a href="#添加cpus节点" class="headerlink" title="添加cpus节点"></a>添加cpus节点</h3><p>首先添加CPU节点，I.MX6ULL采用Cortex-A7架构，而且只有一个CPU，因此只有一个cpu0节点，完成以后如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> 		cpus &#123;</span><br><span class="line"><span class="number">5</span> 				<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">6</span> 				<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> 				<span class="comment">//CPU0 节点</span></span><br><span class="line"><span class="number">9</span> 				cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">10</span> 						compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">11</span> 						device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">12</span> 						reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">13</span> 				&#125;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第4~14行，cpus节点，此节点用于描述SOC内部的所有CPU，因为I.MX6ULL只有一个CPU，因此只有一个cpu0子节点。</p>
<h3 id="添加soc节点"><a href="#添加soc节点" class="headerlink" title="添加soc节点"></a>添加soc节点</h3><p>像uart，iic控制器等等这些都属于SOC内部外设，因此一般会创建一个叫做soc的父节点来管理这些SOC内部外设的子节点，添加soc节点以后的myfirst.dts文件内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> 		cpus &#123;</span><br><span class="line"><span class="number">5</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">6</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> 			<span class="comment">//CPU0 节点</span></span><br><span class="line"><span class="number">9</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">10</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">11</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">12</span> 				reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">13</span> 			&#125;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> 		<span class="comment">//soc 节点</span></span><br><span class="line"><span class="number">17</span> 		soc &#123;</span><br><span class="line"><span class="number">18</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">19</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> 			compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">21</span> 			ranges;</span><br><span class="line"><span class="number">22</span> 		&#125;</span><br><span class="line"><span class="number">23</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第17~22行，soc节点，soc节点设置#address-cells&#x3D;&lt;1&gt;，#size-cells&#x3D;&lt;1&gt;，这样soc子节点的reg属性中起始地占用一个字长，地址空间长度也占用一个字长。</p>
<h3 id="添加ocram节点"><a href="#添加ocram节点" class="headerlink" title="添加ocram节点"></a>添加ocram节点</h3><p>根据第2点的要求，添加ocram节点，ocram是I.MX6ULL内部RAM，因此ocram节点应该是soc节点的子节点。ocram起始地址为0x00900000，大小为128KB(0x20000)，添加ocram节点以后myfirst.dts文件内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> 		cpus &#123;</span><br><span class="line"><span class="number">5</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">6</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> 			<span class="comment">//CPU0 节点</span></span><br><span class="line"><span class="number">9</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">10</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">11</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">12</span> 				reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">13</span> 			&#125;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> 		<span class="comment">//soc 节点</span></span><br><span class="line"><span class="number">17</span> 		soc &#123;</span><br><span class="line"><span class="number">18</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">19</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> 			compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">21</span> 			ranges;</span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span> 			<span class="comment">//ocram 节点</span></span><br><span class="line"><span class="number">24</span> 			ocram: sram@<span class="number">00900000</span> &#123;</span><br><span class="line"><span class="number">25</span> 				compatible = <span class="string">&quot;fsl,lpm-sram&quot;</span>;</span><br><span class="line"><span class="number">26</span> 				reg = &lt;<span class="number">0x00900000</span> <span class="number">0x20000</span>&gt;;</span><br><span class="line"><span class="number">27</span> 			&#125;;</span><br><span class="line"><span class="number">28</span> 		&#125;</span><br><span class="line"><span class="number">29</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第24~27行，ocram节点，第24行节点名字@后面的0x00900000就是ocram的起始地址。第26行的reg属性也指明了ocram内存的起始地址为0x00900000，大小为0x20000。</p>
<h3 id="添加aips1、aips2和和aips3这三个子节点"><a href="#添加aips1、aips2和和aips3这三个子节点" class="headerlink" title="添加aips1、aips2和和aips3这三个子节点"></a>添加aips1、aips2和和aips3这三个子节点</h3><p>I.MX6ULL内部分为三个域：aips1<del>3，这三个域分管不同的外设控制器，aips1</del>3这三个域对应的内存范围如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/3.jpeg" alt="img not found"></p>
<p>我们先在设备树中添加这三个域对应的子节点。aips1~3这三个域都属于soc节点的子节点，完成以后的myfirst.dts文件内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> 		cpus &#123;</span><br><span class="line"><span class="number">5</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">6</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> 			<span class="comment">//CPU0 节点</span></span><br><span class="line"><span class="number">9</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">10</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">11</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">12</span> 				reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">13</span> 			&#125;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> 		<span class="comment">//soc 节点</span></span><br><span class="line"><span class="number">17</span> 		soc &#123;</span><br><span class="line"><span class="number">18</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">19</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> 			compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">21</span> 			ranges;</span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span> 			<span class="comment">//ocram 节点</span></span><br><span class="line"><span class="number">24</span> 			ocram: sram@<span class="number">00900000</span> &#123;</span><br><span class="line"><span class="number">25</span> 				compatible = <span class="string">&quot;fsl,lpm-sram&quot;</span>;</span><br><span class="line"><span class="number">26</span> 				reg = &lt;<span class="number">0x00900000</span> <span class="number">0x20000</span>&gt;;</span><br><span class="line"><span class="number">27</span> 			&#125;;</span><br><span class="line"><span class="number">28</span></span><br><span class="line"><span class="number">29</span> 		    <span class="comment">//aips1 节点</span></span><br><span class="line"><span class="number">30</span> 		    aips1: aips-bus@<span class="number">02000000</span> &#123;</span><br><span class="line"><span class="number">31</span> 			    compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">32</span> 			    <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">33</span> 			    <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">34</span> 			    reg = &lt;<span class="number">0x02000000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">35</span> 			    ranges;</span><br><span class="line"><span class="number">36</span> 		    &#125;</span><br><span class="line"><span class="number">37</span></span><br><span class="line"><span class="number">38</span> 		    <span class="comment">//aips2 节点</span></span><br><span class="line"><span class="number">39</span> 		    aips2: aips-bus@<span class="number">02100000</span> &#123;</span><br><span class="line"><span class="number">40</span> 			    compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">41</span> 			    <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">42</span> 			    <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">43</span> 			    reg = &lt;<span class="number">0x02100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">44</span> 			    ranges;</span><br><span class="line"><span class="number">45</span> 		    &#125;</span><br><span class="line"><span class="number">46</span></span><br><span class="line"><span class="number">47</span> 		    <span class="comment">//aips3 节点</span></span><br><span class="line"><span class="number">48</span> 		    aips3: aips-bus@<span class="number">02200000</span> &#123;</span><br><span class="line"><span class="number">49</span> 			    compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">50</span> 			    <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">51</span> 			    <span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">52</span> 			    reg = &lt;<span class="number">0x02200000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">53</span> 			    ranges;</span><br><span class="line"><span class="number">54</span> 		    &#125;</span><br><span class="line"><span class="number">55</span>      &#125;</span><br><span class="line"><span class="number">56</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第30<del>36行，aips1节点。第39</del>45行，aips2节点。第48~54行，aips3节点</p>
<h3 id="添加ecspi1、usbotg1和和rngb这三个外设控制器节点"><a href="#添加ecspi1、usbotg1和和rngb这三个外设控制器节点" class="headerlink" title="添加ecspi1、usbotg1和和rngb这三个外设控制器节点"></a>添加ecspi1、usbotg1和和rngb这三个外设控制器节点</h3><p>最后我们在myfirst.dts文件中加入ecspi1，usbotg1和rngb这三个外设控制器对应的节点，其中ecspi1属于aips1的子节点，usbotg1属于aips2的子节点，rngb属于aips3的子节点。最终的myfirst.dts文件内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> / &#123;</span><br><span class="line"><span class="number">2</span> 		compatible = <span class="string">&quot;fsl,imx6ull-alientek-evk&quot;</span>, <span class="string">&quot;fsl,imx6ull&quot;</span>;</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> 		cpus &#123;</span><br><span class="line"><span class="number">5</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">6</span> 			<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> 			<span class="comment">//CPU0 节点</span></span><br><span class="line"><span class="number">9</span> 			cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line"><span class="number">10</span> 				compatible = <span class="string">&quot;arm,cortex-a7&quot;</span>;</span><br><span class="line"><span class="number">11</span> 				device_type = <span class="string">&quot;cpu&quot;</span>;</span><br><span class="line"><span class="number">12</span> 				reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line"><span class="number">13</span> 			&#125;;</span><br><span class="line"><span class="number">14</span> 		&#125;;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> 		<span class="comment">//soc 节点</span></span><br><span class="line"><span class="number">17</span> 		soc &#123;</span><br><span class="line"><span class="number">18</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">19</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">20</span> 			compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">21</span> 			ranges;</span><br><span class="line"><span class="number">22</span></span><br><span class="line"><span class="number">23</span> 			<span class="comment">//ocram 节点</span></span><br><span class="line"><span class="number">24</span> 			ocram: sram@<span class="number">00900000</span> &#123;</span><br><span class="line"><span class="number">25</span> 				compatible = <span class="string">&quot;fsl,lpm-sram&quot;</span>;</span><br><span class="line"><span class="number">26</span> 				reg = &lt;<span class="number">0x00900000</span> <span class="number">0x20000</span>&gt;;</span><br><span class="line"><span class="number">27</span> 			&#125;;</span><br><span class="line"><span class="number">28</span> 		&#125;</span><br><span class="line"><span class="number">29</span> 		<span class="comment">//aips1 节点</span></span><br><span class="line"><span class="number">30</span> 		aips1: aips-bus@<span class="number">02000000</span> &#123;</span><br><span class="line"><span class="number">31</span> 			compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">32</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">33</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">34</span> 			reg = &lt;<span class="number">0x02000000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">35</span> 			ranges;</span><br><span class="line"><span class="number">36</span> 		</span><br><span class="line"><span class="number">37</span> 			<span class="comment">//ecspi1 节点</span></span><br><span class="line"><span class="number">38</span> 			ecspi1: ecspi@<span class="number">02008000</span> &#123;</span><br><span class="line"><span class="number">39</span> 				<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">40</span> 				<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"><span class="number">41</span> 				compatible = <span class="string">&quot;fsl,imx6ul-ecspi&quot;</span>, <span class="string">&quot;fsl,imx51-ecspi&quot;</span>;</span><br><span class="line"><span class="number">42</span> 				reg = &lt;<span class="number">0x02008000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">43</span> 				status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">44</span> 			&#125;;</span><br><span class="line"><span class="number">45</span> 		&#125;</span><br><span class="line"><span class="number">46</span></span><br><span class="line"><span class="number">47</span> 		<span class="comment">//aips2 节点</span></span><br><span class="line"><span class="number">48</span> 		aips2: aips-bus@<span class="number">02100000</span> &#123;</span><br><span class="line"><span class="number">49</span> 			compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">50</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">51</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">52</span> 			reg = &lt;<span class="number">0x02100000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">53</span> 			ranges;</span><br><span class="line"><span class="number">54</span></span><br><span class="line"><span class="number">55</span> 			<span class="comment">//usbotg1 节点</span></span><br><span class="line"><span class="number">56</span> 			usbotg1: usb@<span class="number">02184000</span> &#123;</span><br><span class="line"><span class="number">57</span> 				compatible = <span class="string">&quot;fsl,imx6ul-usb&quot;</span>, <span class="string">&quot;fsl,imx27-usb&quot;</span>;</span><br><span class="line"><span class="number">58</span> 				reg = &lt;<span class="number">0x02184000</span> <span class="number">0x200</span>&gt;;</span><br><span class="line"><span class="number">59</span> 				status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line"><span class="number">60</span> 			&#125;;</span><br><span class="line"><span class="number">61</span> 		&#125;</span><br><span class="line"><span class="number">62</span></span><br><span class="line"><span class="number">63</span> 		<span class="comment">//aips3 节点</span></span><br><span class="line"><span class="number">64</span> 		aips3: aips-bus@<span class="number">02200000</span> &#123;</span><br><span class="line"><span class="number">65</span> 			compatible = <span class="string">&quot;fsl,aips-bus&quot;</span>, <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"><span class="number">66</span> 			<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">67</span> 			<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line"><span class="number">68</span> 			reg = &lt;<span class="number">0x02200000</span> <span class="number">0x100000</span>&gt;;</span><br><span class="line"><span class="number">69</span> 			ranges;</span><br><span class="line"><span class="number">70</span></span><br><span class="line"><span class="number">71</span> 			<span class="comment">//rngb 节点</span></span><br><span class="line"><span class="number">72</span> 			rngb: rngb@<span class="number">02284000</span> &#123;</span><br><span class="line"><span class="number">73</span> 				compatible = <span class="string">&quot;fsl,imx6sl-rng&quot;</span>, <span class="string">&quot;fsl,imx-rng&quot;</span>, <span class="string">&quot;imx-rng&quot;</span>;</span><br><span class="line"><span class="number">74</span> 				reg = &lt;<span class="number">0x02284000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line"><span class="number">75</span> 			&#125;;</span><br><span class="line"><span class="number">76</span> 		&#125;</span><br><span class="line"><span class="number">77</span> &#125;</span><br></pre></td></tr></table></figure>
<p>第38<del>44行，ecspi1外设控制器节点。第56</del>60行，usbotg1外设控制器节点。第72~75行，rngb外设控制器节点。</p>
<p>至此，myfirst.dts这个小型的模板设备树就编写好了，基本和imx6ull.dtsi很像，可以看做是imx6ull.dtsi的缩小版。在myfirst.dts里面我们仅仅是编写了I.MX6ULL的外设控制器节点，像IIC接口，SPI接口下所连接的具体设备我们并没有写，因为具体的设备其设备树属性内容不同。</p>
<h1 id="常用OF操作函数"><a href="#常用OF操作函数" class="headerlink" title="常用OF操作函数"></a>常用OF操作函数</h1><h2 id="设备树在系统中的体现"><a href="#设备树在系统中的体现" class="headerlink" title="设备树在系统中的体现"></a>设备树在系统中的体现</h2><p><code>Linux内核启动的时候会解析设备树中各个节点的信息，并且在根文件系统的/proc/device-tree目录下根据节点名字创建不同文件夹</code>，如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/4.jpeg" alt="img not found"></p>
<p>我们依次来看一下这些属性和子节点。</p>
<h3 id="根节点“-x2F-”各个属性"><a href="#根节点“-x2F-”各个属性" class="headerlink" title="根节点“&#x2F;”各个属性"></a>根节点“&#x2F;”各个属性</h3><p>在图中，根节点属性属性表现为一个个的文件(图中细字体文件)，比如图1中的“#address-cells”、“#size-cells”、“compatible”、“model”和“name”这5个文件，它们在设备树中就是根节点的5个属性。既然是文件那么肯定可以查看其内容，输入cat命令来查看model和compatible这两个文件的内容，结果如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/5.jpeg" alt="img not found"><br>从图可以看出，文件model的内容是“Freescalei.MX6ULL14x14EVKBoard”，文件compatible的内容为“fsl,imx6ull-14x14-evkfsl,imx6ull”。打开文件imx6ull-alientek-emmc.dts查看一下，这不正是根节点“&#x2F;”的model和compatible属性值吗！</p>
<h3 id="根节点“-x2F-”各子节点"><a href="#根节点“-x2F-”各子节点" class="headerlink" title="根节点“&#x2F;”各子节点"></a>根节点“&#x2F;”各子节点</h3><p>图中各个文件夹(图中粗字体文件夹)就是根节点“&#x2F;”的各个子节点，比如“aliases”、“backlight”、“chosen”和“clocks”等等。大家可以查看一下imx6ull-alientek-emmc.dts和imx6ull.dtsi这两个文件，看看根节点的子节点都有哪些，看看是否和图中的一致。<br>&#x2F;proc&#x2F;device-tree目录就是设备树在根文件系统中的体现，同样是按照树形结构组织的，进入&#x2F;proc&#x2F;device-tree&#x2F;soc目录中就可以看到soc节点的所有子节点，如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/6.jpeg" alt="img not found"><br>和根节点“&#x2F;”一样，图中的所有文件分别为soc节点的属性文件和子节点文件夹。大家可以自行查看一下这些属性文件的内容是否和imx6ull.dtsi中soc节点的属性值相同，也可以进入“busfreq”这样的文件夹里面查看soc节点的子节点信息。</p>
<h2 id="特殊节点"><a href="#特殊节点" class="headerlink" title="特殊节点"></a>特殊节点</h2><p>在根节点“&#x2F;”中有两个特殊的子节点：aliases和chosen，我们接下来看一下这两个特殊的子节点。</p>
<h3 id="aliases子节点"><a href="#aliases子节点" class="headerlink" title="aliases子节点"></a>aliases子节点</h3><p>打开imx6ull.dtsi文件，aliases节点内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span> aliases &#123;</span><br><span class="line"><span class="number">19</span> 		can0 = &amp;flexcan1;</span><br><span class="line"><span class="number">20</span> 		can1 = &amp;flexcan2;</span><br><span class="line"><span class="number">21</span> 		ethernet0 = &amp;fec1;</span><br><span class="line"><span class="number">22</span> 		ethernet1 = &amp;fec2;</span><br><span class="line"><span class="number">23</span> 		gpio0 = &amp;gpio1;</span><br><span class="line"><span class="number">24</span> 		gpio1 = &amp;gpio2;</span><br><span class="line">......</span><br><span class="line"><span class="number">42</span> 		spi0 = &amp;ecspi1;</span><br><span class="line"><span class="number">43</span> 		spi1 = &amp;ecspi2;</span><br><span class="line"><span class="number">44</span> 		spi2 = &amp;ecspi3;</span><br><span class="line"><span class="number">45</span> 		spi3 = &amp;ecspi4;</span><br><span class="line"><span class="number">46</span> 		usbphy0 = &amp;usbphy1;</span><br><span class="line"><span class="number">47</span> 		usbphy1 = &amp;usbphy2;</span><br><span class="line"><span class="number">48</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>单词aliases的意思是“别名”，因此aliases节点的主要功能就是定义别名，定义别名的目的就是为了方便访问节点。不过我们一般会在节点命名的时候会加上label，然后通过&amp;label来访问节点，这样也很方便，而且设备树里面大量的使用&amp;label的形式来访问节点。</p>
<h3 id="chosen子节点"><a href="#chosen子节点" class="headerlink" title="chosen子节点"></a>chosen子节点</h3><p>chosen并不是一个真实的设备，chosen节点主要是为了uboot向Linux内核传递数据，重点是bootargs参数。一般.dts文件中alientek-emmc.dts中chosen节点内容如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span> chosen &#123;</span><br><span class="line"><span class="number">19</span>     <span class="built_in">stdout</span>-path = &amp;uart1;</span><br><span class="line"><span class="number">20</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>从以上代码中可以看出，chosen节点仅仅设置了属性“stdout-path”，表示标准输出使用uart1。但是当我们进入到&#x2F;proc&#x2F;device-tree&#x2F;chosen目录里面，会发现多了bootargs这个属性，如图所示<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/7.jpeg" alt="img not found"></p>
<p>输入cat命令查看bootargs这个文件的内容，结果如图所示：<br><img src="/2023/06/08/Linux%E8%AE%BE%E5%A4%87%E6%A0%91/8.jpeg" alt="img not found"></p>
<h2 id="设备树常用OF操作函数"><a href="#设备树常用OF操作函数" class="headerlink" title="设备树常用OF操作函数"></a>设备树常用OF操作函数</h2><p>设备树描述了设备的详细信息，这些信息包括数字类型的、字符串类型的、数组类型的，我们在编写驱动的时候需要获取到这些信息。比如设备树使用reg属性描述了某个外设的寄存器地址为0X02005482，长度为0X400，我们在编写驱动的时候需要获取到reg属性的0X02005482和0X400这两个值，然后初始化外设。<br>Linux内核给我们提供了一系列的函数来获取设备树中的节点或者属性信息，这一系列的函数都有一个统一的前缀“of_”，所以在很多资料里面也被叫做OF函数。这些OF函数原型都定义在include&#x2F;linux&#x2F;of.h文件中。</p>
<h3 id="查找节点的OF函数"><a href="#查找节点的OF函数" class="headerlink" title="查找节点的OF函数"></a>查找节点的OF函数</h3><p>设备都是以节点的形式“挂”到设备树上的，因此要想获取这个设备的其他属性信息，必须先获取到这个设备的节点。Linux内核使用device_node结构体来描述一个节点，此结构体定义在文件include&#x2F;linux&#x2F;of.h中，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">49</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> &#123;</span></span><br><span class="line"><span class="number">50</span> 		<span class="type">const</span> <span class="type">char</span> *name; <span class="comment">/* 节点名字 */</span></span><br><span class="line"><span class="number">51</span> 		<span class="type">const</span> <span class="type">char</span> *type; <span class="comment">/* 设备类型 */</span></span><br><span class="line"><span class="number">52</span> 		phandle phandle;</span><br><span class="line"><span class="number">53</span> 		<span class="type">const</span> <span class="type">char</span> *full_name; <span class="comment">/* 节点全名 */</span></span><br><span class="line"><span class="number">54</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">fwnode_handle</span> <span class="title">fwnode</span>;</span></span><br><span class="line"><span class="number">55</span></span><br><span class="line"><span class="number">56</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">properties</span>;</span> <span class="comment">/* 属性 */</span></span><br><span class="line"><span class="number">57</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">deadprops</span>;</span> <span class="comment">/* removed 属性 */</span></span><br><span class="line"><span class="number">58</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">parent</span>;</span> <span class="comment">/* 父节点 */</span></span><br><span class="line"><span class="number">59</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">child</span>;</span> <span class="comment">/* 子节点 */</span></span><br><span class="line"><span class="number">60</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">sibling</span>;</span></span><br><span class="line"><span class="number">61</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line"><span class="number">62</span> 		<span class="type">unsigned</span> <span class="type">long</span> _flags;</span><br><span class="line"><span class="number">63</span> 		<span class="type">void</span> *data;</span><br><span class="line"><span class="number">64</span> 	<span class="meta">#<span class="keyword">if</span> defined(CONFIG_SPARC)</span></span><br><span class="line"><span class="number">65</span> 		<span class="type">const</span> <span class="type">char</span> *path_component_name;</span><br><span class="line"><span class="number">66</span> 		<span class="type">unsigned</span> <span class="type">int</span> unique_id;</span><br><span class="line"><span class="number">67</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">of_irq_controller</span> *<span class="title">irq_trans</span>;</span></span><br><span class="line"><span class="number">68</span> 	<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="number">69</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>与查找节点有关的OF函数有5个，我们依次来看一下。</p>
<h4 id="of-find-node-by-name函数"><a href="#of-find-node-by-name函数" class="headerlink" title="of_find_node_by_name函数"></a>of_find_node_by_name函数</h4><p>of_find_node_by_name函数通过节点名字查找指定的节点，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_name</span><span class="params">(<span class="keyword">struct</span> device_node *from, <span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>from</code>：开始查找的节点，如果为NULL表示从根节点开始查找整个设备树。<br><code>name</code>：要查找的节点名字。<br><code>返回值</code>：找到的节点，如果为NULL表示查找失败。</p>
<h4 id="of-find-node-by-type函数"><a href="#of-find-node-by-type函数" class="headerlink" title="of_find_node_by_type函数"></a>of_find_node_by_type函数</h4><p>of_find_node_by_type函数通过type属性查找指定的节点，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_type</span><span class="params">(<span class="keyword">struct</span> device_node *from, <span class="type">const</span> <span class="type">char</span> *type)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>from</code>：开始查找的节点，如果为NULL表示从根节点开始查找整个设备树。<br><code>type</code>：要查找的节点对应的type字符串，也就是device_type属性值。<br><code>返回值</code>：找到的节点，如果为NULL表示查找失败。</p>
<h4 id="of-find-compatible-node函数"><a href="#of-find-compatible-node函数" class="headerlink" title="of_find_compatible_node函数"></a>of_find_compatible_node函数</h4><p>of_find_compatible_node函数根据type和compatible这两个属性查找指定的节点，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_compatible_node</span><span class="params">(<span class="keyword">struct</span> device_node *from, <span class="type">const</span> <span class="type">char</span> *type,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *compatible)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>from</code>：开始查找的节点，如果为NULL表示从根节点开始查找整个设备树。<br><code>type</code>：要查找的节点对应的type字符串，也就是device_type属性值，可以为NULL，表示忽略掉device_type属性。<br><code>compatible</code>：要查找的节点所对应的compatible属性列表。<br><code>返回值</code>：找到的节点，如果为NULL表示查找失败</p>
<h4 id="of-find-matching-node-and-match函数"><a href="#of-find-matching-node-and-match函数" class="headerlink" title="of_find_matching_node_and_match函数"></a>of_find_matching_node_and_match函数</h4><p>of_find_matching_node_and_match函数通过of_device_id匹配表来查找指定的节点，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_find_matching_node_and_match</span><span class="params">(<span class="keyword">struct</span> device_node *from,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="keyword">struct</span> of_device_id *matches, <span class="type">const</span> <span class="keyword">struct</span> of_device_id **match)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>from</code>：开始查找的节点，如果为NULL表示从根节点开始查找整个设备树。<br><code>matches</code>：of_device_id匹配表，也就是在此匹配表里面查找节点。<br><code>match</code>：找到的匹配的of_device_id。<br><code>返回值</code>：找到的节点，如果为NULL表示查找失败。</p>
<h4 id="of-find-node-by-path函数"><a href="#of-find-node-by-path函数" class="headerlink" title="of_find_node_by_path函数"></a>of_find_node_by_path函数</h4><p>of_find_node_by_path函数通过路径来查找指定的节点，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">struct</span> device_node *<span class="title function_">of_find_node_by_path</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>path</code>：带有全路径的节点名，可以使用节点的别名，比如“&#x2F;backlight”就是backlight这个节点的全路径。<br><code>返回值</code>：找到的节点，如果为NULL表示查找失败</p>
<h3 id="查找父-x2F-子节点的OF函数"><a href="#查找父-x2F-子节点的OF函数" class="headerlink" title="查找父&#x2F;子节点的OF函数"></a>查找父&#x2F;子节点的OF函数</h3><p>Linux内核提供了几个查找节点对应的父节点或子节点的OF函数，我们依次来看一下。</p>
<h4 id="of-get-parent函数"><a href="#of-get-parent函数" class="headerlink" title="of_get_parent函数"></a>of_get_parent函数</h4><p>of_get_parent函数用于获取指定节点的父节点(如果有父节点的话)，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> device_node *<span class="title function_">of_get_parent</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *node)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>node</code>：要查找父节点的节点。<br><code>返回值</code>：找到的父节点。</p>
<h3 id="提取属性值的OF函数"><a href="#提取属性值的OF函数" class="headerlink" title="提取属性值的OF函数"></a>提取属性值的OF函数</h3><p><code>节点的属性信息里面保存了驱动所需要的内容，因此对于属性值的提取非常重要，Linux内核中使用结构体property表示属性</code>，此结构体同样定义在文件include&#x2F;linux&#x2F;of.h中，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">35</span> <span class="class"><span class="keyword">struct</span> <span class="title">property</span> &#123;</span></span><br><span class="line"><span class="number">36</span> 		<span class="type">char</span> *name; <span class="comment">/* 属性名字 */</span></span><br><span class="line"><span class="number">37</span> 		<span class="type">int</span> length; <span class="comment">/* 属性长度 */</span></span><br><span class="line"><span class="number">38</span> 		<span class="type">void</span> *value; <span class="comment">/* 属性值 */</span></span><br><span class="line"><span class="number">39</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">next</span>;</span> <span class="comment">/* 下一个属性 */</span></span><br><span class="line"><span class="number">40</span> 		<span class="type">unsigned</span> <span class="type">long</span> _flags;</span><br><span class="line"><span class="number">41</span> 		<span class="type">unsigned</span> <span class="type">int</span> unique_id;</span><br><span class="line"><span class="number">42</span> 		<span class="class"><span class="keyword">struct</span> <span class="title">bin_attribute</span> <span class="title">attr</span>;</span></span><br><span class="line"><span class="number">43</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>Linux内核也提供了提取属性值的OF函数，我们依次来看一下。</p>
<h4 id="of-find-property函数"><a href="#of-find-property函数" class="headerlink" title="of_find_property函数"></a>of_find_property函数</h4><p>of_find_property函数用于查找指定的属性，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> property *<span class="title function_">of_find_property</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> *lenp)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>name</code>：属性名字。<br><code>lenp</code>：属性值的字节数<br><code>返回值</code>：找到的属性。</p>
<h4 id="of-property-count-elems-of-size函数"><a href="#of-property-count-elems-of-size函数" class="headerlink" title="of_property_count_elems_of_size函数"></a>of_property_count_elems_of_size函数</h4><p>of_property_count_elems_of_size函数用于获取属性中元素的数量，比如reg属性值是一个数组，那么使用此函数可以获取到这个数组的大小，此函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_count_elems_of_size</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, <span class="type">int</span> elem_size)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>proname</code>：需要统计元素数量的属性名字。<br><code>elem_size</code>：元素长度。<br><code>返回值</code>：得到的属性元素数量。</p>
<h4 id="of-property-read-u32-index函数"><a href="#of-property-read-u32-index函数" class="headerlink" title="of_property_read_u32_index函数"></a>of_property_read_u32_index函数</h4><p>of_property_read_u32_index函数用于从属性中获取指定标号的u32类型数据值(无符号32位)，比如某个属性有多个u32类型的值，那么就可以使用此函数来获取指定标号的数据值，此函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32_index</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u32 index, u32 *out_value)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>proname</code>：要读取的属性名字。<br><code>index</code>：要读取的值标号。<br><code>out_value</code>：读取到的值<br><code>返回值</code>：0读取成功，负值，读取失败，-EINVAL表示属性不存在，-ENODATA表示没有要读取的数据，-EOVERFLOW表示属性值列表太小。</p>
<h4 id="of-property-read-u8-array函数、of-property-read-u16-array函数、of-property-read-u32-array函数、of-property-read-u64-array函数"><a href="#of-property-read-u8-array函数、of-property-read-u16-array函数、of-property-read-u32-array函数、of-property-read-u64-array函数" class="headerlink" title="of_property_read_u8_array函数、of_property_read_u16_array函数、of_property_read_u32_array函数、of_property_read_u64_array函数"></a>of_property_read_u8_array函数、of_property_read_u16_array函数、of_property_read_u32_array函数、of_property_read_u64_array函数</h4><p>这4个函数分别是读取属性中u8、u16、u32和u64类型的数组数据，比如大多数的reg属性都是数组数据，可以使用这4个函数一次读取出reg属性中的所有数据。这四个函数的原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u8_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u8 *out_values, <span class="type">size_t</span> sz)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u16_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u16 *out_values, <span class="type">size_t</span> sz)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u32 *out_values, <span class="type">size_t</span> sz)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u64_array</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u64 *out_values,<span class="type">size_t</span> sz)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>proname</code>：要读取的属性名字。<br><code>out_value</code>：读取到的数组值，分别为u8、u16、u32和u64。<br><code>sz</code>：要读取的数组元素数量。<br><code>返回值</code>：0，读取成功，负值，读取失败，-EINVAL表示属性不存在，-ENODATA表示没有要读取的数据，-EOVERFLOW表示属性值列表太小。</p>
<h4 id="of-property-read-u8函数、of-property-read-u16函数、of-property-read-u32函数、of-property-read-u64函数"><a href="#of-property-read-u8函数、of-property-read-u16函数、of-property-read-u32函数、of-property-read-u64函数" class="headerlink" title="of_property_read_u8函数、of_property_read_u16函数、of_property_read_u32函数、of_property_read_u64函数"></a>of_property_read_u8函数、of_property_read_u16函数、of_property_read_u32函数、of_property_read_u64函数</h4><p>有些属性只有一个整形值，这四个函数就是用于读取这种只有一个整形值的属性，分别用于读取u8、u16、u32和u64类型属性值，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u8</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u8 *out_value)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u16</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u16 *out_value)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u32</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u32 *out_value)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_u64</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *np,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *propname, u64 *out_value)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>proname</code>：要读取的属性名字。<br><code>out_value</code>：读取到的数组值。<br><code>返回值</code>：0，读取成功，负值，读取失败，-EINVAL表示属性不存在，-ENODATA表示没有要读取的数据，-EOVERFLOW表示属性值列表太小。</p>
<h4 id="of-property-read-string函数"><a href="#of-property-read-string函数" class="headerlink" title="of_property_read_string函数"></a>of_property_read_string函数</h4><p>of_property_read_string函数用于读取属性中字符串值，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_property_read_string</span><span class="params">(<span class="keyword">struct</span> device_node *np, <span class="type">const</span> <span class="type">char</span> *propname, <span class="type">const</span> <span class="type">char</span> **out_string)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>proname</code>：要读取的属性名字。<br><code>out_string</code>：读取到的字符串值。<br><code>返回值</code>：0，读取成功，负值，读取失败。</p>
<h4 id="of-n-addr-cells函数"><a href="#of-n-addr-cells函数" class="headerlink" title="of_n_addr_cells函数"></a>of_n_addr_cells函数</h4><p>of_n_addr_cells函数用于获取#address-cells属性值，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_n_addr_cells</span><span class="params">(<span class="keyword">struct</span> device_node *np)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>返回值</code>：获取到的#address-cells属性值。</p>
<h4 id="of-n-size-cells函数"><a href="#of-n-size-cells函数" class="headerlink" title="of_n_size_cells函数"></a>of_n_size_cells函数</h4><p>of_size_cells函数用于获取#size-cells属性值，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_n_size_cells</span><span class="params">(<span class="keyword">struct</span> device_node *np)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>返回值</code>：获取到的#size-cells属性值。</p>
<h3 id="其他常用的OF函数"><a href="#其他常用的OF函数" class="headerlink" title="其他常用的OF函数"></a>其他常用的OF函数</h3><h4 id="of-device-is-compatible函数"><a href="#of-device-is-compatible函数" class="headerlink" title="of_device_is_compatible函数"></a>of_device_is_compatible函数</h4><p>of_device_is_compatible函数用于查看节点的compatible属性是否有包含compat指定的字符串，也就是检查设备节点的兼容性，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_device_is_compatible</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> device_node *device, <span class="type">const</span> <span class="type">char</span> *compat)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>device</code>：设备节点。<br><code>compat</code>：要查看的字符串。<br><code>返回值</code>：0，节点的compatible属性中不包含compat指定的字符串；正数，节点的compatible属性中包含compat指定的字符串。</p>
<h4 id="of-get-address函数"><a href="#of-get-address函数" class="headerlink" title="of_get_address函数"></a>of_get_address函数</h4><p>of_get_address函数用于获取地址相关属性，主要是“reg”或者“assigned-addresses”属性值，函数属性如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> __be32 *<span class="title function_">of_get_address</span><span class="params">(<span class="keyword">struct</span> device_node *dev,</span></span><br><span class="line"><span class="params"><span class="type">int</span> index, u64 *size, <span class="type">unsigned</span> <span class="type">int</span> *flags)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>dev</code>：设备节点。<br><code>index</code>：要读取的地址标号。<br><code>size</code>：地址长度。<br><code>flags</code>：参数，比如IORESOURCE_IO、IORESOURCE_MEM等返回值：读取到的地址数据首地址，为NULL的话表示读取失败。</p>
<h4 id="of-translate-address函数"><a href="#of-translate-address函数" class="headerlink" title="of_translate_address函数"></a>of_translate_address函数</h4><p>of_translate_address函数负责将从设备树读取到的地址转换为物理地址，函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u64 <span class="title function_">of_translate_address</span><span class="params">(<span class="keyword">struct</span> device_node *dev, <span class="type">const</span> __be32 *in_addr)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>dev</code>：设备节点。<br><code>in_addr</code>：要转换的地址。<br><code>返回值</code>：得到的物理地址，如果为OF_BAD_ADDR的话表示转换失败。</p>
<h4 id="of-address-to-resource函数"><a href="#of-address-to-resource函数" class="headerlink" title="of_address_to_resource函数"></a>of_address_to_resource函数</h4><p>IIC、SPI、GPIO等这些外设都有对应的寄存器，这些寄存器其实就是一组内存空间，Linux内核使用resource结构体来描述一段内存空间，“resource”翻译出来就是“资源”，因此用resource结构体描述的都是设备资源信息，resource结构体定义在文件include&#x2F;linux&#x2F;ioport.h中，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span> <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> &#123;</span></span><br><span class="line"><span class="number">19</span>     <span class="type">resource_size_t</span> start;</span><br><span class="line"><span class="number">20</span>     <span class="type">resource_size_t</span> end;</span><br><span class="line"><span class="number">21</span>     <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"><span class="number">22</span>     <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"><span class="number">23</span>     <span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">parent</span>, *<span class="title">sibling</span>, *<span class="title">child</span>;</span></span><br><span class="line"><span class="number">24</span> &#125;;</span><br></pre></td></tr></table></figure>
<p>对于32位的SOC来说，resource_size_t是u32类型的。其中start表示开始地址，end表示结束地址，name是这个资源的名字，flags是资源标志位，一般表示资源类型，可选的资源标志定义在文件include&#x2F;linux&#x2F;ioport.h中，如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BITS 0x000000ff</span></span><br><span class="line"><span class="number">2</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_TYPE_BITS 0x00001f00</span></span><br><span class="line"><span class="number">3</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_IO 0x00000100</span></span><br><span class="line"><span class="number">4</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MEM 0x00000200</span></span><br><span class="line"><span class="number">5</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_REG 0x00000300</span></span><br><span class="line"><span class="number">6</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_IRQ 0x00000400</span></span><br><span class="line"><span class="number">7</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_DMA 0x00000800</span></span><br><span class="line"><span class="number">8</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BUS 0x00001000</span></span><br><span class="line"><span class="number">9</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_PREFETCH 0x00002000</span></span><br><span class="line"><span class="number">10</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_READONLY 0x00004000</span></span><br><span class="line"><span class="number">11</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_CACHEABLE 0x00008000</span></span><br><span class="line"><span class="number">12</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_RANGELENGTH 0x00010000</span></span><br><span class="line"><span class="number">13</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_SHADOWABLE 0x00020000</span></span><br><span class="line"><span class="number">14</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_SIZEALIGN 0x00040000</span></span><br><span class="line"><span class="number">15</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_STARTALIGN 0x00080000</span></span><br><span class="line"><span class="number">16</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MEM_64 0x00100000</span></span><br><span class="line"><span class="number">17</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_WINDOW 0x00200000</span></span><br><span class="line"><span class="number">18</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_MUXED 0x00400000</span></span><br><span class="line"><span class="number">19</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_EXCLUSIVE 0x08000000</span></span><br><span class="line"><span class="number">20</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_DISABLED 0x10000000</span></span><br><span class="line"><span class="number">21</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_UNSET 0x20000000</span></span><br><span class="line"><span class="number">22</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_AUTO 0x40000000</span></span><br><span class="line"><span class="number">23</span> <span class="meta">#<span class="keyword">define</span> IORESOURCE_BUSY 0x80000000</span></span><br></pre></td></tr></table></figure>
<p>大家一般最常见的资源标志就是IORESOURCE_MEM、IORESOURCE_REG和IORESOURCE_IRQ等。接下来我们回到of_address_to_resource函数，此函数看名字像是从设备树里面提取资源值，但是本质上就是将reg属性值，然后将其转换为resource结构体类型，函数原型如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">of_address_to_resource</span><span class="params">(<span class="keyword">struct</span> device_node *dev, <span class="type">int</span> index, <span class="keyword">struct</span> resource *r)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>dev</code>：设备节点。<br><code>index</code>：地址资源标号。<br><code>r</code>：得到的resource类型的资源值。<br><code>返回值</code>：0，成功；负值，失败。</p>
<h4 id="of-iomap函数"><a href="#of-iomap函数" class="headerlink" title="of_iomap函数"></a>of_iomap函数</h4><p>of_iomap函数用于直接内存映射，以前我们会通过ioremap函数来完成物理地址到虚拟地址的映射，采用设备树以后就可以直接通过of_iomap函数来获取内存地址所对应的虚拟地址，不需要使用ioremap函数了。<br>当然了，你也可以使用ioremap函数来完成物理地址到虚拟地址的内存映射，只是在采用设备树以后，大部分的驱动都使用of_iomap函数了。of_iomap函数本质上也是将reg属性中地址信息转换为虚拟地址，如果reg属性有多段的话，可以通过index参数指定要完成内存映射的是哪一段，of_iomap函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __iomem *<span class="title function_">of_iomap</span><span class="params">(<span class="keyword">struct</span> device_node *np, <span class="type">int</span> index)</span></span><br></pre></td></tr></table></figure>
<p>函数参数和返回值含义如下：<br><code>np</code>：设备节点。<br><code>index</code>：reg属性中要完成内存映射的段，如果reg属性只有一段的话index就设置为0。<br><code>返回值</code>：经过内存映射后的虚拟内存首地址，如果为NULL的话表示内存映射失败。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux-Kernel/" rel="tag"># Linux Kernel</a>
              <a href="/tags/Linux-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag"># Linux 设备驱动</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/03/18/%E5%9F%BA%E4%BA%8EArmbian%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%A4%9A%E7%A7%8D%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E5%8D%8F%E8%AE%AE/" rel="prev" title="基于Armbian根文件系统安装配置多种文件共享协议">
                  <i class="fa fa-chevron-left"></i> 基于Armbian根文件系统安装配置多种文件共享协议
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/06/29/LVGL%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7GuiGuiderV1-5%E4%BD%BF%E7%94%A8/" rel="next" title="LVGL快速开发工具GuiGuiderV1.5使用">
                  LVGL快速开发工具GuiGuiderV1.5使用 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Nibil</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">863k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">13:05</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
